# 性能测试记录

## b64002765817318e9f8098968fbc06932173379b

``` ini

BenchmarkDotNet=v0.13.2, OS=Windows 11 (10.0.22621.1413)
13th Gen Intel Core i7-13700K, 1 CPU, 24 logical and 16 physical cores
.NET SDK=7.0.200-preview.22628.1
  [Host]     : .NET 6.0.14 (6.0.1423.7309), X64 RyuJIT AVX2
  DefaultJob : .NET 6.0.14 (6.0.1423.7309), X64 RyuJIT AVX2


```
|                      Method |                 text | paragraphCount | time |            Mean |           Error |          StdDev |      Gen0 |      Gen1 |     Gen2 |   Allocated |
|---------------------------- |--------------------- |--------------- |----- |----------------:|----------------:|----------------:|----------:|----------:|---------:|------------:|
|    **AppendTextMultiParagraph** |                  **123** |             **10** |    **?** |      **7,253.8 ns** |        **82.71 ns** |        **77.36 ns** |    **1.1673** |    **0.0458** |        **-** |    **17.98 KB** |
|         **AppendTextMultiTime** |                  **123** |              **?** |   **10** |      **8,469.5 ns** |        **46.30 ns** |        **38.66 ns** |    **0.8087** |    **0.0153** |        **-** |    **12.47 KB** |
|    **AppendTextMultiParagraph** |                  **123** |            **100** |    **?** |    **197,430.9 ns** |       **611.73 ns** |       **542.28 ns** |   **10.4980** |    **2.6855** |        **-** |   **163.94 KB** |
|         **AppendTextMultiTime** |                  **123** |              **?** |  **100** |    **458,627.4 ns** |       **411.30 ns** |       **364.61 ns** |    **7.3242** |    **0.9766** |        **-** |   **112.17 KB** |
|    **AppendTextMultiParagraph** |                  **123** |           **1000** |    **?** | **14,572,574.7 ns** |    **24,183.55 ns** |    **22,621.31 ns** |   **93.7500** |   **46.8750** |        **-** |  **1619.42 KB** |
|         **AppendTextMultiTime** |                  **123** |              **?** | **1000** | **42,330,301.9 ns** |   **136,679.44 ns** |   **114,133.52 ns** |         **-** |         **-** |        **-** |  **1089.38 KB** |
|                  **AppendText** |                  **123** |              **?** |    **?** |        **543.2 ns** |         **1.56 ns** |         **1.22 ns** |    **0.1793** |    **0.0010** |        **-** |     **2.75 KB** |
| **AppendMultiParagraphAndLine** |  **1231(...)1231 [199]** |             **10** |    **?** |    **137,690.7 ns** |       **760.13 ns** |       **634.74 ns** |   **27.8320** |   **13.6719** |        **-** |   **428.59 KB** |
| **AppendMultiParagraphAndLine** |  **1231(...)1231 [199]** |            **100** |    **?** |  **1,981,517.3 ns** |    **34,422.52 ns** |    **30,514.66 ns** |  **277.3438** |  **136.7188** |        **-** |  **4266.67 KB** |
| **AppendMultiParagraphAndLine** |  **1231(...)1231 [199]** |           **1000** |    **?** | **59,879,896.3 ns** | **1,185,391.89 ns** | **1,541,344.29 ns** | **3222.2222** | **1777.7778** | **555.5556** | **42643.47 KB** |
|                  **AppendText** |  **1231(...)1231 [199]** |              **?** |    **?** |     **13,625.4 ns** |       **270.16 ns** |       **487.15 ns** |    **2.5330** |    **0.3052** |        **-** |    **38.98 KB** |
|                    **LongText** | **TTT(...)TTT [100000]** |              **?** |    **?** | **18,955,692.6 ns** |   **365,493.22 ns** |   **475,244.43 ns** | **1343.7500** |  **843.7500** | **468.7500** | **18456.96 KB** |

## 17ef822f5d5d0e2235970110747c7fbf52cb6cad

加上光标机制

BenchmarkDotNet=v0.13.2, OS=Windows 10 (10.0.19044.2604/21H2/November2021Update)
Intel Core i7-6700 CPU 3.40GHz (Skylake), 1 CPU, 8 logical and 4 physical cores
.NET SDK=7.0.100
  [Host]     : .NET 6.0.13 (6.0.1322.58009), X64 RyuJIT AVX2
  DefaultJob : .NET 6.0.13 (6.0.1322.58009), X64 RyuJIT AVX2


|              Method |                 text | time |          Mean |         Error |        StdDev |        Median |      Gen0 |      Gen1 |     Gen2 |   Allocated |
|-------------------- |--------------------- |----- |--------------:|--------------:|--------------:|--------------:|----------:|----------:|---------:|------------:|
| AppendTextMultiTime |                  123 |   10 |     16.544 μs |     0.3294 μs |     0.6875 μs |     16.349 μs |    2.9297 |         - |        - |    12.05 KB |
|    AppTextMultiLine |                  123 |   10 |     14.424 μs |     0.2847 μs |     0.5685 μs |     14.263 μs |    4.3182 |    0.0153 |        - |    17.64 KB |
| AppendTextMultiTime |                  123 |  100 |    878.110 μs |     9.7958 μs |     8.1800 μs |    874.863 μs |   26.3672 |    1.9531 |        - |   108.24 KB |
|    AppTextMultiLine |                  123 |  100 |    331.179 μs |     3.6004 μs |     3.3679 μs |    330.213 μs |   39.0625 |    7.8125 |        - |   160.79 KB |
| AppendTextMultiTime |                  123 | 1000 | 84,902.782 μs | 1,637.1192 μs | 1,451.2636 μs | 84,553.750 μs |  166.6667 |         - |        - |  1050.59 KB |
|    AppTextMultiLine |                  123 | 1000 | 27,994.789 μs |   880.0421 μs | 2,467.7323 μs | 27,200.253 μs |  281.2500 |  125.0000 |        - |  1588.15 KB |
|          AppendText |                  123 |    ? |      1.313 μs |     0.0476 μs |     0.1320 μs |      1.283 μs |    0.6580 |         - |        - |     2.69 KB |
|          AppendText |  1231(...)3123 [180] |    ? |     24.688 μs |     0.4857 μs |     0.6649 μs |     24.620 μs |    8.7585 |         - |        - |     35.8 KB |
|            LongText | TTT(...)TTT [100000] |    ? | 48,449.083 μs |   954.5975 μs | 1,721.3362 μs | 48,386.682 μs | 3090.9091 | 1363.6364 | 545.4545 | 18457.48 KB |

## 04c1fdd87a2b7c994ac1473fd54a208e553aa7ab

支持分段输入

|              Method |                 text | time |          Mean |         Error |        StdDev |      Gen0 |      Gen1 |     Gen2 |  Allocated |
|-------------------- |--------------------- |----- |--------------:|--------------:|--------------:|----------:|----------:|---------:|-----------:|
| AppendTextMultiTime |                  123 |   10 |     15.736 us |     0.2523 us |     0.2360 us |    2.8687 |         - |        - |   11.72 KB |
|    AppTextMultiLine |                  123 |   10 |     15.417 us |     0.2541 us |     0.2252 us |    3.9063 |         - |        - |   15.98 KB |
| AppendTextMultiTime |                  123 |  100 |    869.252 us |    12.0676 us |    10.6976 us |   26.3672 |    0.9766 |        - |  108.61 KB |
|    AppTextMultiLine |                  123 |  100 |    401.723 us |     5.6316 us |     5.2678 us |   36.1328 |    3.9063 |        - |  148.58 KB |
| AppendTextMultiTime |                  123 | 1000 | 84,483.027 us | 1,001.9454 us | 1,072.0703 us |  142.8571 |         - |        - | 1057.72 KB |
|    AppTextMultiLine |                  123 | 1000 | 35,232.253 us |   670.1005 us |   847.4626 us |  285.7143 |   71.4286 |        - | 1470.49 KB |
|          AppendText |                  123 |    ? |      1.060 us |     0.0187 us |     0.0208 us |    0.5569 |         - |        - |    2.28 KB |
|          AppendText |  1231(...)3123 [180] |    ? |     23.926 us |     0.4252 us |     0.3319 us |    8.6670 |    0.0305 |        - |    35.4 KB |
|            LongText | TTT(...)TTT [100000] |    ? | 46,909.785 us |   934.5071 us | 2,184.3803 us | 3090.9091 | 1363.6364 | 545.4545 | 18456.9 KB |

## 5f7166d4db81ed44bb0cb7dbe3c5355c63d34651

加上字符属性设置

|     Method |                 text |            Mean |         Error |          StdDev |      Gen0 |      Gen1 |     Gen2 |   Allocated |
|----------- |--------------------- |----------------:|--------------:|----------------:|----------:|----------:|---------:|------------:|
| AppendText |                  123 |        921.8 ns |      18.41 ns |        15.37 ns |    0.5398 |         - |        - |     2.21 KB |
| AppendText |  1231(...)3123 [180] |     21,564.7 ns |     224.42 ns |       187.40 ns |    8.6365 |         - |        - |    35.33 KB |
|   LongText | TTT(...)TTT [100000] | 44,904,371.4 ns | 786,198.08 ns | 1,335,024.01 ns | 3166.6667 | 1416.6667 | 583.3333 | 18457.13 KB |

## db955a8e03d4b258c31ed805233a1e3bd9527fd0

完成更多布局

一个字符需要申请 180 个 byte 的内存参与布局

|     Method |                 text |            Mean |         Error |        StdDev |      Gen0 |      Gen1 |     Gen2 |   Allocated |
|----------- |--------------------- |----------------:|--------------:|--------------:|----------:|----------:|---------:|------------:|
| AppendText |                  123 |        831.3 ns |      16.08 ns |      24.56 ns |    0.4835 |         - |        - |     1.98 KB |
| AppendText |  1231(...)3123 [180] |     20,579.6 ns |     186.36 ns |     145.50 ns |    8.5754 |    0.0305 |        - |    35.09 KB |
|   LongText | TTT(...)TTT [100000] | 43,049,424.4 ns | 854,221.60 ns | 799,039.41 ns | 3166.6667 | 1416.6667 | 583.3333 | 18456.66 KB |

## 7d4a19cc5eeb09a1fa34c2f83ed162b23c6e0734

对每个字符的布局节省一个数组的创建

|     Method |                 text |            Mean |         Error |        StdDev |      Gen0 |      Gen1 |     Gen2 |   Allocated |
|----------- |--------------------- |----------------:|--------------:|--------------:|----------:|----------:|---------:|------------:|
| AppendText |                  123 |        609.0 ns |      11.67 ns |       9.11 ns |    0.4129 |         - |        - |     1.69 KB |
| AppendText |  1231(...)3123 [180] |     15,231.1 ns |     294.33 ns |     289.07 ns |    6.1340 |         - |        - |    25.13 KB |
|   LongText | TTT(...)TTT [100000] | 25,938,670.8 ns | 414,858.20 ns | 388,058.62 ns | 2187.5000 | 1093.7500 | 500.0000 | 12987.59 KB |

## 2bb428e2d633a9eb4d8e8c0d9d7b2d52ff0d4d82

|     Method |                 text |            Mean |         Error |          StdDev |      Gen0 |      Gen1 |     Gen2 |   Allocated |
|----------- |--------------------- |----------------:|--------------:|----------------:|----------:|----------:|---------:|------------:|
| AppendText |                  123 |        669.4 ns |      13.38 ns |        23.79 ns |    0.4416 |         - |        - |      1.8 KB |
| AppendText |  1231(...)3123 [180] |     17,325.7 ns |     345.02 ns |       656.44 ns |    7.8735 |         - |        - |    32.16 KB |
|   LongText | TTT(...)TTT [100000] | 33,275,238.0 ns | 659,844.83 ns | 1,738,295.20 ns | 2866.6667 | 1400.0000 | 600.0000 | 16893.65 KB |

## 220f30a53feae9d4074ddacc0e11ca4b46700abb

将 Run 拆分为 CharData 之后

|     Method |                 text |            Mean |           Error |          StdDev |      Gen0 |      Gen1 |     Gen2 |   Allocated |
|----------- |--------------------- |----------------:|----------------:|----------------:|----------:|----------:|---------:|------------:|
| AppendText |                  123 |        608.4 ns |        11.47 ns |        18.85 ns |    0.4530 |         - |        - |     1.85 KB |
| AppendText |  1231(...)3123 [180] |     14,168.9 ns |       250.63 ns |       234.44 ns |    8.5602 |         - |        - |    34.97 KB |
|   LongText | TTT(...)TTT [100000] | 48,370,846.6 ns | 1,603,462.69 ns | 4,727,845.92 ns | 3363.6364 | 1545.4545 | 636.3636 | 18456.16 KB |

## 272620dbf0e1d7ea93184947e3e615cb8e5fb7b3

加上性能测试

|     Method |                 text |           Mean |         Error |        StdDev |      Gen0 |     Gen1 |     Gen2 |   Allocated |
|----------- |--------------------- |---------------:|--------------:|--------------:|----------:|---------:|---------:|------------:|
| AppendText |                  123 |       775.2 ns |      15.46 ns |      29.42 ns |    0.4854 |        - |        - |     1.98 KB |
| AppendText |  1231(...)3123 [180] |    12,467.0 ns |     193.32 ns |     206.85 ns |    5.8136 |        - |        - |    23.81 KB |
|   LongText | TTT(...)TTT [100000] | 9,823,145.3 ns | 194,569.12 ns | 224,066.09 ns | 2093.7500 | 921.8750 | 921.8750 | 11911.14 KB |